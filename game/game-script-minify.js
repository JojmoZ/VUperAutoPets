let socket,enemyOnlineName,enemyOnlineLives,username,isPaired=!1,pairingTimeout=null,pairingDuration=5e4;function connectWebSocket(){socket=new WebSocket("https://nova-dolomite-mink.glitch.me"),socket.onopen=()=>{console.log("Connected to server")},socket.onmessage=e=>{const t=JSON.parse(e.data);console.log("Received message from server:",t),"waiting"===t.type&&console.log("Waiting for an opponent..."),"paired"===t.type&&(console.log("Paired with an opponent!"),isPaired=!0,sendPlayerData()),"opponentData"===t.type&&(console.log("Received opponent data:",t),enemyLineup=t.battleLineup,enemyTeamName=t.teamName,enemyOnlineName=t.username,enemyOnlineLives=t.lives,receivedOpponentData=!0,checkStartCondition()),"start"===t.type&&(console.log("Both players are ready. Starting the game!"),hideLoadingScreen(),letsplayonline())},socket.onclose=()=>{console.log("Connection closed"),isPaired=!1}}connectWebSocket();let BossBattle,playerDataSent=!1,receivedOpponentData=!1,gameStarted=!1;const canvas=document.getElementById("battleCanvas"),curtainTop=document.getElementById("curtainTop"),curtainBottom=document.getElementById("curtainBottom"),targetSequenceCoins="CUTCUTCUT",targetSequenceLives="JANGANAMPAS",bossBattleSequence="RECSEL";let ctx=canvas.getContext("2d"),userInput="",cheatCode="";const heartImg=new Image,fistImg=new Image;let bandageImg=new Image,starImg=new Image,enemyLineup=[null,null,null,null,null],battleLineup=JSON.parse(localStorage.getItem("battleLineup"))||[null,null,null,null,null];const hoverInfo=document.getElementById("hoverInfo");let coins,totalcoinforbattle,enemyTeamName,items=[],currentItem1=null,currentItem2=null,playing=!1,canPlay=!1,randomAnimals=JSON.parse(localStorage.getItem("randomAnimals"))||[];const maxShopAnimals=3,maxSlots=5;let shopAnimals=[];fetch("../assets/jsons/shopAnimals.json").then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{shopAnimals=e})).catch((e=>console.error("Error loading shopAnimals:",e)));let lastFrameTime=performance.now(),middleHeart=document.getElementById("middleHeart"),lives=parseInt(localStorage.getItem("lives"))||3,hearts=[document.getElementById("heart1"),document.getElementById("heart2"),document.getElementById("heart3")],originalBattleLineup=[],selectedAdjective=null,selectedNoun=null,teamName=localStorage.getItem("teamName")||"";const trashBin=document.getElementById("trashBin"),freezeButton=document.getElementById("freezeButton"),backgroundMusic=document.getElementById("backgroundMusic"),battleMusic=document.getElementById("battleMusic");backgroundMusic.volume=.2,battleMusic.volume=.05;const busSound=document.getElementById("busSound"),buySound=document.getElementById("buySound"),eatSound=document.getElementById("eatSound"),rollSound=document.getElementById("rollSound"),sellSound=document.getElementById("sellSound"),logged=localStorage.getItem("loggedin");if(!logged){function clearLocalStorageExceptUsers(){const e=["users"];Object.keys(localStorage).forEach((t=>{e.includes(t)||localStorage.removeItem(t)}))}clearLocalStorageExceptUsers(),window.location.href="/login/index.html"}function saveRandomAnimals(){localStorage.setItem("randomAnimals",JSON.stringify(randomAnimals))}function rollfirst(){const e=JSON.parse(localStorage.getItem("ownedAnimals"));if(!e||0===e.length)return void setTimeout((()=>{window.location.href="/home/homepage.html"}),3e3);const t=randomAnimals.filter((e=>e&&e.frozen)),n=t.length,a=(e||shopAnimals).sort((()=>Math.random()-.5)).slice(0,3-n);randomAnimals=[...t,...a],renderRandomAnimals(),saveRandomAnimals()}function showCurtains(){curtainTop.style.visibility="visible",curtainBottom.style.visibility="visible"}function hideCurtains(){curtainTop.style.visibility="hidden",curtainBottom.style.visibility="hidden"}function closeCurtains(){showCurtains(),curtainTop.style.height="50vh",curtainBottom.style.height="50vh"}function openCurtains(e){setTimeout((()=>{curtainTop.style.height="0",curtainBottom.style.height="0",setTimeout((()=>{e&&e()}),500)}),500)}function rollShopAnimals(){updateCoinsDisplay();const e=randomAnimals.filter((e=>e&&e.frozen)),t=e.length,n=JSON.parse(localStorage.getItem("ownedAnimals")),a=(n||shopAnimals).sort((()=>Math.random()-.5)).slice(0,3-t);randomAnimals=[...e,...a],renderRandomAnimals(),saveRandomAnimals()}function renderRandomAnimals(){const e=document.getElementById("random-animals");e.innerHTML="";for(let t=0;t<3;t++){const n=randomAnimals[t]||null,a=document.createElement("div");a.classList.add("animal"),a.setAttribute("data-index",t);const s=document.createElement("div");if(s.classList.add("stone"),a.appendChild(s),n){const e=document.createElement("img");if(e.src=n.img,e.alt=n.name,e.style.aspectRatio="1/1",e.style.transform="scaleX(-1)",e.setAttribute("draggable",!0),e.addEventListener("dragstart",(n=>{hideHoverInfo();const a=e.offsetWidth,s=e.offsetHeight,o=document.createElement("canvas");o.width=a,o.height=s;const l=o.getContext("2d");l.clearRect(0,0,o.width,o.height),l.scale(-1,1),l.drawImage(e,-a,0,a,s),o.style.position="absolute",o.style.top="-1000px",o.style.left="-1000px",o.style.pointerEvents="none",document.body.appendChild(o),n.dataTransfer.setDragImage(o,o.width/2,o.height/2),setTimeout((()=>{o.remove()}),0),n.dataTransfer.setData("text/plain",t),n.dataTransfer.setData("source","shop"),showFreezeBin()})),e.addEventListener("dragend",hideBins),e.addEventListener("mouseover",(e=>{showHoverInfo(`${n.name} - Cost: ${n.cost}`,e)})),e.addEventListener("mousemove",(e=>{showHoverInfo(`${n.name} - Cost: ${n.cost}`,e)})),e.addEventListener("mouseout",hideHoverInfo),n.frozen){const t=document.createElement("div");t.classList.add("ice-overlay"),a.appendChild(t),e.style.width="5.8rem",e.style.height="5.8rem"}a.appendChild(e);const s=document.createElement("div");s.classList.add("stat-container");const o=document.createElement("div");o.classList.add("stat-icon");const l=document.createElement("img");l.src="../assets/game-asset/fist.png";const i=document.createElement("span");i.textContent=n.attack,i.classList.add("stat-text"),o.appendChild(l),o.appendChild(i);const r=document.createElement("div");r.classList.add("stat-icon");const c=document.createElement("img");c.src="../assets/game-asset/stat-heart.png";const m=document.createElement("span");m.textContent=n.health,m.classList.add("stat-text"),r.appendChild(c),r.appendChild(m),s.appendChild(o),s.appendChild(r),a.appendChild(s)}e.appendChild(a)}}function saveBattleLineup(){localStorage.setItem("battleLineup",JSON.stringify(battleLineup))}function dragStart(e){const t=e.target.closest(".animal").getAttribute("data-index");e.dataTransfer.setData("text/plain",t)}function initializeAnimal(e){return{...e,level:1,bar:0}}function handleDrop(e){e.preventDefault();const t=4-parseInt(e.currentTarget.getAttribute("data-slot"),10),n=e.dataTransfer.getData("text/plain"),a=e.dataTransfer.getData("source");if("shop"===a){const e=parseInt(n,10),a=randomAnimals[e],s=battleLineup[t];if(s&&s.name==a.name&&s.level<3&&coins>=a.cost){coins-=a.cost;const t=1===s.level?2:3;s.bar+=1,s.bar>=t&&(s.bar=0,s.level+=1,2===s.level&&(s.attack+=2,s.health+=3),3===s.level&&(s.attack+=3,s.health+=4)),playAnimalSound(s.sound),randomAnimals.splice(e,1),renderBattleSlots(),renderRandomAnimals(),saveBattleLineup()}else if(!battleLineup[t]&&coins>=a.cost)battleLineup[t]=a,coins-=a.cost,playBuySound(),console.log(a),playAnimalSound(a.sound),updateCoinsDisplay(),randomAnimals.splice(e,1),renderRandomAnimals(),saveBattleLineup(),saveRandomAnimals(),renderBattleSlots();else{console.log(a.cost),console.log(battleLineup[t]),console.log(s);const n=document.querySelector(`#random-animals .animal[data-index="${e}"] img`);n&&jitterImage(n)}}else if("battle"===a){const e=parseInt(n,10),a=battleLineup[e],s=battleLineup[t];if(s&&a&&s.name==a.name&&e!==t){if(s.level<3){const e=1===s.level?2:3;s.bar+=1,s.bar>=e&&(s.bar=0,s.level+=1,2===s.level&&(s.attack+=2,s.health+=3),3===s.level&&(s.attack+=3,s.health+=4))}playAnimalSound(s.sound),battleLineup[e]=null,renderBattleSlots(),saveBattleLineup()}else if(a){const n=battleLineup[t];battleLineup[t]=a,battleLineup[e]=n,renderBattleSlots(),saveBattleLineup()}}else if("item"===a){e.dataTransfer.getData("itemName"),e.dataTransfer.getData("itemEffect");const n=battleLineup[t];n&&handleItemDrop(e,n)}}function playAnimalSound(e){console.log("Playing sound:",e);const t=new Audio(`${e}`);t.currentTime=0,t.play()}function handleDragOver(e){e.preventDefault()}function showHoverInfo(e,t){hoverInfo.textContent=e,hoverInfo.style.left=`${t.pageX+10}px`,hoverInfo.style.top=`${t.pageY+10}px`,hoverInfo.style.opacity=1}function hideHoverInfo(){hoverInfo.style.opacity=0}function playBuySound(){buySound.currentTime=0,buySound.play()}function playSellSound(){sellSound.currentTime=0,sellSound.play()}function playEatSound(){eatSound.currentTime=0,eatSound.play()}function playRollSound(){rollSound.currentTime=0,rollSound.play()}function playBusSound(){return new Promise(((e,t)=>{try{const n=new Audio("../assets/sound/bus sound.mp3");n.currentTime=0,n.onended=()=>{console.log("Bus sound playback completed."),e()},n.onerror=e=>{console.error("Error playing bus sound:",e),t(e)},n.play().catch((e=>{console.error("Error starting bus sound:",e),t(e)}))}catch(e){console.error("Unexpected error in playBusSound:",e),t(e)}}))}function hideTeamName(){document.getElementById("teamNameContainer").classList.add("hidden")}function showTeamName(){document.getElementById("teamNameContainer").classList.remove("hidden")}function renderBattleSlots(){document.querySelectorAll(".battle-slot").forEach(((e,t)=>{e.setAttribute("data-slot",t);const n=battleLineup[4-t];if(n){e.innerHTML="";const a=document.createElement("div");a.classList.add("animal-wrapper"),a.style.position="relative";const s=document.createElement("img");s.src=n.img,s.alt=n.name,s.style.width="100%",s.style.height="auto",s.style.objectFit="contain",s.style.maxHeight="100%",s.style.maxWidth="100%",s.style.aspectRatio="1/1",s.style.transform="scaleX(-1)",s.draggable=!0;const o=document.createElement("img");3==n.level?o.src=`../assets/Levels/Lv${n.level}.png`:o.src=`../assets/Levels/Lv${n.level}_${n.bar}.png`,o.alt=`Level ${n.level} Bar ${n.bar}`,o.style.zIndex="10101",o.style.position="absolute",o.style.top="-2.5rem",o.style.left="0",o.style.width="3.125rem",o.style.height="3.125rem",a.appendChild(o);const l=document.createElement("div");l.classList.add("stat-container");const i=document.createElement("div");i.classList.add("stat-icon");const r=document.createElement("img");r.src="../assets/game-asset/fist.png",r.draggable=!1;const c=document.createElement("span");c.textContent=n.attack,c.classList.add("stat-text"),i.appendChild(r),i.appendChild(c);const m=document.createElement("div");m.classList.add("stat-icon");const d=document.createElement("img");d.src="../assets/game-asset/stat-heart.png",d.draggable=!1;const u=document.createElement("span");if(u.textContent=n.health,u.classList.add("stat-text"),m.appendChild(d),m.appendChild(u),l.appendChild(i),l.appendChild(m),a.appendChild(s),a.appendChild(l),"SpawnBus"===n.specialEffect){setInterval((()=>{!function(){const e=document.createElement("div");e.style.position="absolute",e.style.zIndex="2",e.style.width="2.5rem",e.style.height="2.5rem",e.style.top=100*Math.random()-30+"%",e.style.left=80*Math.random()+"%",e.style.opacity="1",e.style.transition="top 1.5s ease-out, opacity 1.5s ease-out",e.style.transform="translate(-50%, -50%)";const t=document.createElement("img");t.src="../assets/items/Bus.png",t.alt="Bus Aura",t.style.width="100%",t.style.height="100%",t.draggable=!1,e.appendChild(t),a.appendChild(e),setTimeout((()=>{e.style.top=parseFloat(e.style.top)-20+"px",e.style.opacity="0",setTimeout((()=>{e.remove()}),1300)}),0)}()}),400)}s.addEventListener("dragstart",(e=>{hideHoverInfo();const a=s.offsetWidth,o=s.offsetHeight,l=document.createElement("canvas");l.width=a,l.height=o;const i=l.getContext("2d");i.clearRect(0,0,l.width,l.height),i.scale(-1,1),i.drawImage(s,-a,0,a,o),l.style.position="absolute",l.style.top="-1000px",l.style.left="-1000px",l.style.pointerEvents="none",document.body.appendChild(l),e.dataTransfer.setDragImage(l,l.width/2,l.height/2),setTimeout((()=>{l.remove()}),0),e.dataTransfer.setData("text/plain",4-t),e.dataTransfer.setData("source","battle");const r=Math.floor(n.cost/2);document.getElementById("refundAmountText").textContent=`Sell (${r})`,showTrashBin()})),s.addEventListener("dragend",hideBins),s.addEventListener("mouseover",(e=>{showHoverInfo(`${n.name} - Cost: ${n.cost}`,e)})),s.addEventListener("mousemove",(e=>{showHoverInfo(`${n.name} - Cost: ${n.cost}`,e)})),s.addEventListener("mouseout",hideHoverInfo),e.appendChild(a)}else e.innerHTML=""}))}function renderTeams(){ctx.clearRect(0,0,canvas.width,canvas.height);const e=100,t=210,n=canvas.width-550,a=40;battleLineup.forEach(((t,n)=>{if(t){const s=new Image;s.src=t.img,s.onload=()=>{ctx.save();const o=e+100*(4-n);ctx.translate(o+40,250),ctx.scale(-1,1),ctx.drawImage(s,-40,-40,80,80),ctx.restore(),ctx.drawImage(fistImg,e+100*(4-n),270,a,a),ctx.fillStyle="white",ctx.font="1rem VUper";let l=`${t.attack}`,i=ctx.measureText(l).width,r=e+100*(4-n)+20-i/2;ctx.fillText(l,r,295),ctx.drawImage(heartImg,e+100*(4-n)+40,270,a,a),ctx.fillStyle="white",ctx.font="1rem VUper";let c=`${t.health}`,m=ctx.measureText(c).width,d=e+100*(4-n)+60-m/2;ctx.fillText(c,d,295)}}})),enemyLineup.forEach(((e,s)=>{if(e){const o=new Image;o.src=e.img,o.onload=()=>{ctx.drawImage(o,n+100*s,t,80,80),ctx.drawImage(fistImg,n+100*s,270,a,a),ctx.fillStyle="white",ctx.font="1rem VUper";let l=`${e.attack}`,i=ctx.measureText(l).width,r=n+100*s+20-i/2;ctx.fillText(l,r,295),ctx.drawImage(heartImg,n+100*s+40,270,a,a),ctx.fillStyle="white",ctx.font="1rem VUper";let c=`${e.health}`,m=ctx.measureText(c).width,d=n+100*s+60-m/2;ctx.fillText(c,d,295)}}}))}function checkbattlelineup(){(JSON.parse(localStorage.getItem("battleLineup"))||[]).forEach((e=>{null!=e&&(canPlay=!0)}))}function letsplay(){playing||(BossBattle?(checkbattlelineup(),showCurtains(),playing=!0,closeCurtains(),setTimeout((async()=>{backupLineup(),shiftAnimalsToFront(),await generateBossTeam(),generateBossTeamName();const e=computeBattleResult(battleLineup,enemyLineup);localStorage.setItem("result",e),hideNonBattleElements(),generaateMyInfo(),hideTeamName(),hideCanvas(),randomizeRightHalfMap(),openCurtains((()=>{ShowBottomInfo(),showPauseButton(),showCanvas(),playBattleMusic(),generateEnemyInfo(!0),animateAnimalsIntoPosition((()=>{showBattleText(),updateBattleText((()=>{simulateBattle()}))}))}))}),1e3)):(checkbattlelineup(),showCurtains(),playing=!0,closeCurtains(),setTimeout((()=>{backupLineup(),shiftAnimalsToFront(),generateEnemyTeam(),generateEnemyTeamName(),generaateMyInfo();const e=computeBattleResult(battleLineup,enemyLineup);localStorage.setItem("result",e),hideNonBattleElements(),hideTeamName(),hideCanvas(),randomizeRightHalfMap(),openCurtains((()=>{ShowBottomInfo(),showPauseButton(),showCanvas(),playBattleMusic(),generateEnemyInfo(),animateAnimalsIntoPosition((()=>{showBattleText(),updateBattleText((()=>{simulateBattle()}))}))}))}),1e3)))}async function generateBossTeam(){try{const e=await fetch("../assets/jsons/Boss.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=(await e.json()).sort((()=>Math.random()-.5));for(enemyLineup=t.map((e=>({...e})));enemyLineup.length<5;)enemyLineup.push(null);console.log("Generated Boss Team:",enemyLineup)}catch(e){console.error("Error loading boss team:",e)}}function generateBossTeamName(){enemyTeamName="RECSEL SQUAD"}function letsplayonline(){if(!playing)if(playerDataSent&&receivedOpponentData){checkbattlelineup();const e=computeBattleResult(battleLineup,enemyLineup);localStorage.setItem("result",e),showCurtains(),playing=!0,closeCurtains(),setTimeout((()=>{backupLineup(),shiftAnimalsToFront(),hideNonBattleElements(),hideTeamName(),hideCanvas(),randomizeRightHalfMap(),generaateMyInfo(),generateEnemyInfo(),openCurtains((()=>{ShowBottomInfo(),showCanvas(),showPauseButton(),playBattleMusic(),animateAnimalsIntoPosition((()=>{showBattleText(),updateBattleText((()=>{simulateBattle()}))}))}))}),1e3)}else console.log("Waiting for both players to send and receive data...")}function sendPlayerData(){isPaired&&(socket.send(JSON.stringify({type:"sendData",battleLineup:battleLineup,teamName:teamName,username:username,lives:lives})),console.log("Sent player data"),playerDataSent=!0,checkStartCondition())}function checkStartCondition(){isPaired&&playerDataSent&&receivedOpponentData&&!gameStarted&&(socket.send(JSON.stringify({type:"start"})),console.log("Notified server to start the game."))}function fadeInElements(){document.querySelectorAll("#teamNameSelectionScreen > *").forEach(((e,t)=>{e.style.opacity=0,e.style.transition=`opacity 0.5s ease ${.2*t}s`,setTimeout((()=>{e.style.opacity=1}),50)}))}function showTeamNameSelection(){hideTeamName();const e=document.getElementById("teamNameSelectionScreen");hideNonBattleElements(),e.classList.add("teamNameSelectionScreen"),e.classList.remove("hidden"),fetch("../assets/jsons/teamnames.json").then((e=>e.json())).then((e=>{const t=e.adjectives,n=e.nouns;populateTeamRow("adjectiveRow",getRandomItems(t,3),"adjective"),populateTeamRow("nounRow",getRandomItems(n,3),"noun")})).catch((e=>console.error("Error fetching team names:",e)))}function getRandomItems(e,t){return e.sort((()=>.5-Math.random())).slice(0,t)}function populateTeamRow(e,t,n){const a=document.getElementById(e);a.innerHTML="",t.forEach((e=>{const t=document.createElement("div");t.classList.add("button-container");const s=document.createElement("div");s.classList.add("stone");const o=document.createElement("button");o.textContent=e,"adjective"===n?o.classList.add("adjective-button"):"noun"===n&&o.classList.add("noun-button"),o.addEventListener("click",(()=>handleTeamNameSelection(n,e))),t.appendChild(s),t.appendChild(o);const l=document.createElement("div");l.id="teamNamePreview",l.style.position="absolute",l.style.bottom="10px",l.style.left="10px",l.style.fontSize="4rem",l.style.fontWeight="bold",l.style.color="white",l.style.backgroundColor="rgba(0,0,0,0.5)",l.style.padding="5px 10px",l.style.borderRadius="5px",l.textContent="The ... ...",l.style.transition="all 0.3s ease",document.getElementById("teamNamePreview")||document.body.appendChild(l),a.appendChild(t)}))}function handleTeamNameSelection(e,t){if("adjective"===e){selectedAdjective=t,document.querySelectorAll(".adjective-button").forEach((e=>{e.classList.remove("selected-button")}));const e=Array.from(document.querySelectorAll(".adjective-button")).find((e=>e.textContent===t));e&&e.classList.add("selected-button")}else if("noun"===e){selectedNoun=t,document.querySelectorAll(".noun-button").forEach((e=>{e.classList.remove("selected-button")}));const e=Array.from(document.querySelectorAll(".noun-button")).find((e=>e.textContent===t));e&&e.classList.add("selected-button")}const n=document.getElementById("teamNamePreview");n.textContent="",n.textContent=selectedAdjective||selectedNoun?selectedAdjective?selectedNoun?`The ${selectedAdjective} ${selectedNoun}`:`The ${selectedAdjective} ...`:`The ... ${selectedNoun}`:"The ... ...";document.getElementById("confirmTeamNameButton").disabled=!(selectedAdjective&&selectedNoun)}function animateAnimalsIntoPosition(e){const t=canvas.width-550,n=battleLineup.map(((e,t)=>{if(e){const n=new Image;return n.src=e.img,n.onload=()=>console.log(`Player pet ${t} loaded`),n}return null})),a=enemyLineup.map(((e,t)=>{if(e){const n=new Image;return n.src=e.img,n.onload=()=>console.log(`Enemy pet ${t} loaded`),n}return null}));let s=0,o=performance.now();requestAnimationFrame((function l(i){if(paused)return void requestAnimationFrame(l);const r=(i-o)/1e3;o=i,ctx.clearRect(0,0,canvas.width,canvas.height);const c=(m=s/2)*(2-m);var m;const d=30*Math.sin(c*Math.PI*2*5)*(1-c);n.forEach(((e,t)=>{if(e){const n=-80,a=.2*t,s=n+(100+100*(4-t)-n)*Math.min(Math.max(c-a,0)/(1-a),1),o=210-d;ctx.save(),ctx.translate(s+40,o+40),ctx.scale(-1,1),ctx.drawImage(e,-40,-40,80,80),ctx.restore()}})),a.forEach(((e,n)=>{if(e){const a=canvas.width+80,s=.2*n,o=a-(a-(t+100*n))*Math.min(Math.max(c-s,0)/(1-s),1),l=210-d;ctx.drawImage(e,o,l,80,80)}})),s+=r,s<=2?requestAnimationFrame(l):e&&e()}))}function showNonBattleElements(){hideCanvas(),document.getElementById("battleSlotsContainer").classList.remove("hidden"),document.getElementById("controls").classList.remove("hidden"),document.getElementById("refreshButton").classList.remove("hidden"),document.getElementById("startBattleButton").classList.remove("hidden"),document.getElementById("startBattleButtonOnline").classList.remove("hidden"),document.getElementById("freezeButton").classList.remove("hidden"),document.getElementById("backArrow").classList.remove("hidden"),playBackgroundMusic()}function hideNonBattleElements(){console.log("hiding"),document.getElementById("battleSlotsContainer").classList.add("hidden"),document.getElementById("controls").classList.add("hidden"),document.getElementById("refreshButton").classList.add("hidden"),document.getElementById("startBattleButton").classList.add("hidden"),document.getElementById("startBattleButtonOnline").classList.add("hidden"),document.getElementById("freezeButton").classList.add("hidden"),document.getElementById("backArrow").classList.add("hidden"),console.log("Curtain visibility:",curtainTop.style.visibility,curtainBottom.style.visibility),console.log("Curtain heights:",curtainTop.style.height,curtainBottom.style.height),playBattleMusic()}function showCanvas(){document.getElementById("battleCanvas").classList.remove("hidden")}function hideCanvas(){document.getElementById("battleCanvas").classList.add("hidden")}function adjustCanvasSize(){const e=document.getElementById("battleCanvas");e.width=window.innerWidth,e.height=.5*window.innerHeight,ctx=e.getContext("2d")}function loadassets(){fistImg.src="../assets/game-asset/fist.png",heartImg.src="../assets/game-asset/heart.png",bandageImg.src="../assets/game-asset/hurt.png",starImg.src="../assets/game-asset/star.png"}function playBackgroundMusic(){battleMusic.pause(),battleMusic.currentTime=0,backgroundMusic.play()}function playBattleMusic(){backgroundMusic.pause(),backgroundMusic.currentTime=0,battleMusic.play()}function updateCoinsDisplay(){localStorage.setItem("gamecoins",coins),document.getElementById("coins").textContent=`Coins: ${coins}`}function generateEnemyTeamName(){fetch("../assets/jsons/teamnames.json").then((e=>e.json())).then((e=>{const t=e.adjectives,n=e.nouns,a=t[Math.floor(Math.random()*t.length)],s=n[Math.floor(Math.random()*n.length)];enemyTeamName=`${a} ${s}`})).catch((e=>console.error("Error fetching team names:",e)))}function generateEnemyTeam(){const e=coins+calculateTeamCost(battleLineup);let t=0;enemyLineup=[];let n=0;const a=shopAnimals.map((e=>({...e,weight:e.cost+5*Math.random()}))).slice().sort(((e,t)=>t.weight-e.weight));for(;enemyLineup.length<5&&t<e;){let s={...a[Math.floor(Math.random()*Math.min(5,a.length))]},o=s.cost;if(Math.random()<.4?e-t>=6*s.cost?(s.level=3,o=6*s.cost):e-t>=3*s.cost?(s.level=2,o=3*s.cost):(s.level=1,o=s.cost):(s.level=1,o=s.cost),t+o>e){if(n++,n>1e3){console.warn("Failed to generate full enemy lineup. Exiting loop.");break}}else if(Math.random()<.2&&!s.specialEffect&&e-t>=o+9&&(s.specialEffect="SpawnBus",o+=9),t+=o,enemyLineup.push(s),n++,n>1e3){console.warn("Failed to generate full enemy lineup. Exiting loop.");break}}for(;enemyLineup.length<5;)enemyLineup.push(null);console.log("Generated enemy lineup:",enemyLineup)}function calculateTeamCost(e){return e.reduce(((e,t)=>t?e+t.cost:e),0)}function animateHeadbutt(e,t,n){const a=new Audio("../assets/sound/hit sound.wav"),s=210,o=canvas.width-550,l=210,i=canvas.width/2-60,r=500;let c=0,m=null,d=performance.now();const u=new Image;u.src=e.img;const p=new Image;function h(g){if(paused)return m||(m=g),void requestAnimationFrame(h);m&&(d+=g-m,m=null);const f=(g-d)/1e3;d=g,ctx.clearRect(0,0,canvas.width,canvas.height),renderFullTeam();const y=easeInOutQuad(c/.5),I=500-(500-i)*y,x=o+(i+60-o)*y;c===Math.floor(.25)&&(a.currentTime=0,a.play()),ctx.save(),ctx.translate(I+40,250),ctx.scale(-1,1),ctx.drawImage(u,-40,-40,80,80),ctx.restore(),ctx.drawImage(fistImg,I,270,40,40),ctx.drawImage(heartImg,I+40,270,40,40),ctx.fillStyle="white",ctx.font="1rem VUper";let v=`${e.attack}`,w=ctx.measureText(v).width,S=I+20-w/2,B=`${e.health}`,E=ctx.measureText(B).width,T=I+60-E/2;ctx.fillText(v,S,295),ctx.fillText(B,T,295),ctx.drawImage(p,x,l,80,80),ctx.drawImage(fistImg,x,270,40,40),ctx.drawImage(heartImg,x+40,270,40,40),ctx.fillStyle="white",ctx.font="1rem VUper";let L=`${t.attack}`,b=ctx.measureText(L).width,C=x+20-b/2,A=`${t.health}`,N=ctx.measureText(A).width,k=x+60-N/2;ctx.fillText(L,C,295),ctx.fillText(A,k,295),c+=f,c<=.5?requestAnimationFrame(h):setTimeout((()=>{ctx.drawImage(bandageImg,I+10,s,60,60),ctx.drawImage(bandageImg,x+10,l,60,60),setTimeout((()=>{showDamage(I,e.attack,x,t.attack,u,p,e.health,t.health,(()=>{!function(a,s,o,l){let c=0,m=performance.now();const d=r;let h=null;function g(r){if(paused)return h||(h=r),void requestAnimationFrame(g);h&&(m+=r-h,h=null);const f=(r-m)/1e3;m=r,ctx.clearRect(0,0,canvas.width,canvas.height),renderFullTeam();const y=easeInOutQuad(c/(d/1e3)),I=i+(a-i)*y,x=i+60+(o-i-60)*y;ctx.save(),ctx.translate(I+40,s+40),ctx.scale(-1,1),ctx.drawImage(u,-40,-40,80,80),ctx.restore(),ctx.drawImage(fistImg,I,s+60,40,40),ctx.drawImage(heartImg,I+40,s+60,40,40),ctx.fillStyle="white",ctx.font="1rem VUper";let v=`${e.attack}`,w=I+20-ctx.measureText(v).width/2,S=`${e.health}`,B=I+60-ctx.measureText(S).width/2;ctx.fillText(v,w,s+85),ctx.fillText(S,B,s+85),ctx.drawImage(p,x,l,80,80),ctx.drawImage(fistImg,x,l+60,40,40),ctx.drawImage(heartImg,x+40,l+60,40,40);let E=`${t.attack}`,T=x+20-ctx.measureText(E).width/2,L=`${t.health}`,b=x+60-ctx.measureText(L).width/2;ctx.fillText(E,T,l+85),ctx.fillText(L,b,l+85),c+=f,c<=d/1e3?requestAnimationFrame(g):n()}requestAnimationFrame(g)}(500,s,o,l)}))}),300)}),1)}p.src=t.img,u.onload=()=>{p.onload=()=>{requestAnimationFrame(h)}}}function backupLineup(){battleLineup.some((e=>null!==e))?originalBattleLineup=battleLineup.map((e=>e?{...e,originalAttack:e.attack,originalHealth:e.health}:null)):console.warn("Cannot backup lineup: No animals in battle lineup.")}function shiftAnimalsToFront(){const e=e=>{const t=e.filter((e=>null!==e));for(;t.length<5;)t.push(null);return t};battleLineup=e(battleLineup),enemyLineup=e(enemyLineup)}function restoreOriginalLineup(){battleLineup=originalBattleLineup.map((e=>e?{...e,attack:e.originalAttack,health:e.originalHealth}:null)),renderBattleSlots()}function showDamage(e,t,n,a,s,o,l,i,r){let c=1;const m=210,d=-25;let u=0;function p(){if(paused)return void requestAnimationFrame(p);ctx.clearRect(0,0,canvas.width,canvas.height),renderFullTeam(),ctx.save(),ctx.translate(e+40,250),ctx.scale(-1,1),ctx.drawImage(s,-40,-40,80,80),ctx.restore(),ctx.drawImage(fistImg,e,270,40,40),ctx.drawImage(heartImg,e+40,270,40,40),ctx.drawImage(o,n,m,80,80),ctx.drawImage(fistImg,n,270,40,40),ctx.drawImage(heartImg,n+40,270,40,40);let h=`${t}`,g=ctx.measureText(h).width,f=e+20-g/2,y=`${l}`,I=ctx.measureText(y).width,x=e+60-I/2;ctx.fillText(h,f,295),ctx.fillText(y,x,295);let v=`${a}`,w=ctx.measureText(v).width,S=n+20-w/2,B=`${i}`,E=ctx.measureText(B).width,T=n+60-E/2;ctx.fillText(v,S,295),ctx.fillText(B,T,295),ctx.save();const L=u/30,b=3.5-2.5*L;c=1-L,ctx.font=`${b}rem VUper`,ctx.fillStyle="red",ctx.globalAlpha=c,ctx.lineWidth=4,ctx.strokeStyle="black",ctx.strokeText(`${a}`,e+d,209),ctx.strokeText(`${t}`,n+35,206),ctx.fillText(`${a}`,e+d,209),ctx.fillText(`${t}`,n+35,206),ctx.restore(),u<30?(u++,requestAnimationFrame(p)):(ctx.globalAlpha=1,r())}!function r(){if(paused)return void requestAnimationFrame(r);ctx.clearRect(0,0,canvas.width,canvas.height),renderFullTeam(),ctx.save(),ctx.translate(e+40,250),ctx.scale(-1,1),ctx.drawImage(s,-40,-40,80,80),ctx.restore(),ctx.drawImage(fistImg,e,270,40,40),ctx.drawImage(heartImg,e+40,270,40,40),ctx.drawImage(o,n,m,80,80),ctx.drawImage(fistImg,n,270,40,40),ctx.drawImage(heartImg,n+40,270,40,40),ctx.fillStyle="white",ctx.font="1rem VUper";let h=`${t}`,g=ctx.measureText(h).width,f=e+20-g/2,y=`${l}`,I=ctx.measureText(y).width,x=e+60-I/2;ctx.fillText(h,f,295),ctx.fillText(y,x,295),ctx.fillStyle="white",ctx.font="1rem VUper";let v=`${a}`,w=ctx.measureText(v).width,S=n+20-w/2,B=`${i}`,E=ctx.measureText(B).width,T=n+60-E/2;ctx.fillText(v,S,295),ctx.fillText(B,T,295),ctx.save();const L=1+2.5*(u/30);ctx.font=`${L}rem VUper`,ctx.fillStyle="red",ctx.globalAlpha=c,ctx.lineWidth=7,ctx.strokeStyle="black",ctx.strokeText(`${a}`,e+d,209),ctx.strokeText(`${t}`,n+35,206),ctx.fillText(`${a}`,e+d,209),ctx.fillText(`${t}`,n+35,206),ctx.restore(),u<30?(u++,requestAnimationFrame(r)):setTimeout((()=>{c=1,u=0,requestAnimationFrame(p)}),50)}()}function renderFullTeam(){const e=210,t=canvas.width-550,n=80,a=40;battleLineup.forEach(((e,t)=>{if(e&&0!==t){const s=100+100*(4-t);ctx.save(),ctx.translate(s+40,250),ctx.scale(-1,1),ctx.drawImage(getAnimalImage(e.img),-40,-40,n,n),ctx.restore(),ctx.drawImage(fistImg,s,270,a,a),ctx.drawImage(heartImg,s+40,270,a,a),ctx.fillStyle="white",ctx.font="1rem VUper";let o=`${e.attack}`,l=s+20-ctx.measureText(o).width/2,i=`${e.health}`,r=s+60-ctx.measureText(i).width/2;ctx.fillText(o,l,295),ctx.fillText(i,r,295)}})),enemyLineup.forEach(((s,o)=>{if(s&&0!==o){const l=t+100*o;ctx.drawImage(getAnimalImage(s.img),l,e,n,n),ctx.drawImage(fistImg,l,270,a,a),ctx.drawImage(heartImg,l+40,270,a,a),ctx.fillStyle="white",ctx.font="1rem VUper";let i=`${s.attack}`,r=l+20-ctx.measureText(i).width/2,c=`${s.health}`,m=l+60-ctx.measureText(c).width/2;ctx.fillText(i,r,295),ctx.fillText(c,m,295)}}))}function easeInOutQuad(e){return e<.5?2*e*e:(4-2*e)*e-1}function getAnimalImage(e){const t=new Image;return t.src=e,t}function animateDeathFlyOff(e,t,n,a){const s=new Image;s.src=e.img;let o=0;let l,i;"player"===n?(l=100+100*(4-t),i=210):(l=canvas.width-550+100*t,i=210);const r="player"===n?-100:canvas.width+100,c=(l+r)/2,m=i-400;let d=performance.now(),u=null;requestAnimationFrame((function e(t){if(paused)return u||(u=t),void requestAnimationFrame(e);u&&(d+=t-u,u=null);const p=(t-d)/1e3;d=t;const h=o/10,g=(1-h)*(1-h)*l+2*(1-h)*h*c+h*h*r,f=(1-h)*(1-h)*i+2*(1-h)*h*m+h*h*(i+100);ctx.clearRect(g-30,f-30,120,160),renderFullTeam(),ctx.save(),"player"===n?(ctx.translate(g+30,f+30),ctx.scale(-1,1),ctx.drawImage(s,-30,-30,60,60)):ctx.drawImage(s,g,f,60,60),ctx.restore(),o+=10*p*2,"player"===n&&g<=0||"player"!==n&&g>=canvas.width?function(e,t,n){const a=40;let s=0;const o=150,l=80;function i(){if(paused)requestAnimationFrame(i);else{ctx.clearRect(e-o,t-o,2*o,2*o),renderFullTeam();for(let n=0;n<20;n++){const i=n/20*Math.PI*2,r=s/a*o,c=e+Math.cos(i)*r,m=t+Math.sin(i)*r;ctx.globalAlpha=1-s/a,ctx.drawImage(starImg,c-l/2,m-l/2,l,l)}ctx.globalAlpha=1,s++,s<a?requestAnimationFrame(i):n()}}i()}(g,f,(()=>{a()})):o<10&&requestAnimationFrame(e)}))}async function handleBothDeaths(e,t,n){const a=[];e.health<=0&&a.push("SpawnBus"===e.specialEffect?handleBusSpawn(battleLineup,e,"player"):handleDeathAnimation(e,battleLineup.indexOf(e),"player")),t.health<=0&&a.push("SpawnBus"===t.specialEffect?handleBusSpawn(enemyLineup,t,"enemy"):handleDeathAnimation(t,enemyLineup.indexOf(t),"enemy")),console.log("Death Tasks:",a);try{await Promise.all(a),console.log("All death tasks completed.")}catch(e){console.error("Error in death tasks:",e)}e.health<=0&&(battleLineup[battleLineup.indexOf(e)]=null,shiftAnimalsInLineup(battleLineup)),t.health<=0&&(enemyLineup[enemyLineup.indexOf(t)]=null,shiftAnimalsInLineup(enemyLineup)),renderTeams(),setTimeout(n,500)}async function handleBusSpawn(e,t,n){console.log(`Spawning bus for ${n}`,t);const a=e.indexOf(t);if(-1!==a){e[a]=createBus(),renderTeams();try{await playBusSound(),console.log(`Bus spawned successfully for ${n}`)}catch(e){console.error("Error in bus sound:",e)}}else console.error("Animal not found in lineup for bus spawn.")}async function handleDeathAnimation(e,t,n){return console.log(`Animating death for ${n}`,e),new Promise((a=>{animateDeathFlyOff(e,t,n,(()=>{console.log(`Death animation completed for ${n}`),a()}))}))}async function simulateBattle(){localStorage.setItem("ingame",!0);let e=1;function t(){if(e>10||!battleLineup.some((e=>e))||!enemyLineup.some((e=>e))){return checkGameOver(battleLineup.filter((e=>null!==e)).length,enemyLineup.filter((e=>null!==e)).length),void renderTeams()}const n=battleLineup.findIndex((e=>null!==e)),a=battleLineup[n];if(a){const n=enemyLineup.findIndex((e=>null!==e)),s=enemyLineup[n];s&&animateHeadbutt(a,s,(()=>{s.health-=a.attack,a.health-=s.attack,handleBothDeaths(a,s,(()=>{battleLineup.some((e=>e))&&enemyLineup.some((e=>e))?(e++,setTimeout(t,500)):setTimeout((()=>{checkGameOver(battleLineup.filter((e=>null!==e)).length,enemyLineup.filter((e=>null!==e)).length)}),1500)}))}))}}renderTeams(),setTimeout(t,1500)}function shiftAnimalsInLineup(e){let t=e.filter((e=>null!==e));for(;t.length<5;)t.push(null);for(let n=0;n<5;n++)e[n]=t[n]}function updateHeartsDisplay(){hearts.forEach(((e,t)=>{e.src=t<lives?"../assets/game-asset/heart.png":"../assets/game-asset/broken heart.png"}))}function resetGame(){battleLineup=[null,null,null,null,null],enemyLineup=[null,null,null,null,null],localStorage.removeItem("randomAnimals"),localStorage.removeItem("currentItems"),localStorage.removeItem("firstTime"),localStorage.removeItem("teamName"),coins=10,updateCoinsDisplay(),lives<=0&&(lives=3,localStorage.setItem("lives",lives),hearts.forEach((e=>{e.src="../assets/game-asset/heart.png"}))),renderBattleSlots(),renderRandomAnimals(),saveBattleLineup(),hidePauseButton(),showNonBattleElements()}function checkGameOver(e,t){e>t?showWinScreen():e<t?loseLife():showDrawScreen()}function showFreezeBin(){freezeButton.classList.remove("hidden")}function hideFreezeBin(){freezeButton.classList.add("hidden")}function showTrashBin(){trashBin.classList.remove("hidden")}function hideBins(){trashBin.classList.add("hidden"),freezeButton.classList.add("hidden")}function handleTrashDrop(e){e.preventDefault();const t=e.dataTransfer.getData("text/plain");battleLineup[t]=null,renderBattleSlots(),saveBattleLineup()}function loadRandomItems(){const e=JSON.parse(localStorage.getItem("currentItems"))||[];currentItem1=e[0]?{...e[0]}:null,currentItem2=e[1]?{...e[1]}:null,renderItem()}function refreshItems(){0!==items.length?(currentItem1?.frozen||(currentItem1={...items[Math.floor(Math.random()*items.length)]}),currentItem2?.frozen||(currentItem2={...items[Math.floor(Math.random()*items.length)]}),saveCurrentItems(),renderItem()):console.error("No items available to generate!")}function handleItemDrop(e,t){e.preventDefault();const n=e.dataTransfer.getData("itemName"),a=e.dataTransfer.getData("itemEffect"),s=e.dataTransfer.getData("slotId");if(hideFreezeBin(),n&&a&&t){if("Bus"===n&&"SpawnBus"===t.specialEffect){return void jitterImage(document.getElementById(s))}let e=items.find((e=>e.name===n));if(e&&(itemCost=e.cost),coins<itemCost){return void jitterImage(document.getElementById(s))}coins-=itemCost,playEatSound(),applyItemEffect(t,n),"itemSlot"===s?currentItem1=null:"itemSlot2"===s&&(currentItem2=null),saveCurrentItems(),renderItem()}}function renderItem(){const e=document.getElementById("itemSlot"),t=document.getElementById("itemSlot2");function n(e,t){if(!e||!e.img)return;const n=document.createElement("div");n.classList.add("item-wrapper");const a=document.createElement("img");if(a.src=e.img,a.alt=e.name,a.setAttribute("draggable",!0),a.addEventListener("dragstart",handleItemDragStart),e.frozen){const e=document.createElement("div");e.classList.add("ice-overlay"),n.appendChild(e),a.style.width="5.8rem",a.style.height="5.8rem"}n.appendChild(a),t.appendChild(n),a.addEventListener("mouseover",(t=>{showHoverInfo(`${e.name} - Cost: ${e.cost} - Effect: ${e.effect}`,t)})),a.addEventListener("mousemove",(t=>{showHoverInfo(`${e.name} - Cost: ${e.cost} - Effect: ${e.effect}`,t)})),a.addEventListener("mouseout",hideHoverInfo)}e.innerHTML="",t.innerHTML="",n(currentItem1,e),n(currentItem2,t)}function handleItemDragStart(e){hideHoverInfo();const t=e.target.closest(".item-slot").id;showFreezeBin(),"itemSlot"===t?(e.dataTransfer.setData("itemName",currentItem1.name),e.dataTransfer.setData("itemEffect",currentItem1.effect),e.dataTransfer.setData("slotId","itemSlot")):"itemSlot2"===t&&(e.dataTransfer.setData("itemName",currentItem2.name),e.dataTransfer.setData("itemEffect",currentItem2.effect),e.dataTransfer.setData("slotId","itemSlot2")),e.dataTransfer.setData("source","item"),e.target.addEventListener("dragend",hideFreezeBin)}function saveCurrentItems(){localStorage.setItem("currentItems",JSON.stringify([currentItem1,currentItem2]))}function applyItemEffect(e,t){"Apple"===t?e.health+=2:"Honey"===t?e.attack+=3:"Strawberry"===t?(e.health+=1,e.attack+=1):"Bus"==t&&(e.specialEffect="SpawnBus"),updateCoinsDisplay(),renderBattleSlots(),saveBattleLineup()}function createBus(){return{name:"Bus",img:"../assets/items/Bus.png",attack:10,health:10,cost:0,color:"green"}}function loseLife(){if(lives>0){hideBattleText();const e=new Audio("../assets/sound/defeat sound.mp3");e.currentTime=0,e.play();const t=document.getElementById("dimmerOverlay");t.classList.remove("hidden"),middleHeart.src="../assets/game-asset/heart.png",middleHeart.classList.remove("hidden"),setTimeout((()=>{middleHeart.src="../assets/game-asset/semibroken.png"}),1e3),setTimeout((()=>{const e=middleHeart.getBoundingClientRect();middleHeart.style.position="fixed",middleHeart.style.top=`${e.top}px`,middleHeart.style.left=`${e.left}px`,middleHeart.style.width=`${e.width}px`,middleHeart.style.height=`${e.height}px`,middleHeart.style.transform="translate(0, 0)",middleHeart.classList.add("drop"),setTimeout((()=>{middleHeart.classList.remove("drop"),middleHeart.classList.add("hidden"),hearts[lives-1].src="../assets/game-asset/broken heart.png",lives--,localStorage.setItem("lives",lives),lives<=0?DefeatScreen():(showCurtains(),closeCurtains(),restoreOriginalLineup(),setTimeout((()=>{hidePauseButton(),showNonBattleElements(),hideCanvas(),coins+=10,localStorage.removeItem("result"),t.classList.add("hidden"),hideRightSide(),openCurtains((()=>{rollfirst(),updateCoinsDisplay(),location.reload()}))}),1e3))}),1e3)}),1500)}}function checkSequence(){"CUTCUTCUT"===userInput?userInput="":"JANGANAMPAS"===userInput?(lives=3,localStorage.setItem("lives",lives),updateHeartsDisplay(),userInput=""):("RECSEL"==userInput||userInput.length>Math.max(9,11,6))&&(userInput="")}function updateHeartsDisplay(){hearts.forEach(((e,t)=>{e.src=t<lives?"../assets/game-asset/heart.png":"../assets/game-asset/broken heart.png"}))}function jitterImage(e){if(!e)return;const t=window.getComputedStyle(e).transform,n="none"===t?"":t;e.style.transition="transform 0.1s",e.style.transform=`${n} translateX(-5px)`,setTimeout((()=>{e.style.transform=`${n} translateX(5px)`,setTimeout((()=>{e.style.transform=`${n}`}),100)}),100)}function showDrawScreen(){hideBattleText();const e=new Audio("../assets/sound/draw wound.mp3");e.currentTime=0,e.play();const t=document.getElementById("dimmerOverlay");t.classList.remove("hidden");const n=new Image;n.src="../assets/game-asset/frown.png",n.id="frownImage",n.style.position="fixed",n.style.zIndex="123123",n.style.width="6.25rem",n.style.height="6.25rem",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.opacity="0";const a=document.createElement("div");a.textContent="DRAW",a.id="drawText",a.style.position="fixed",a.style.zIndex="123123",a.style.color="white",a.style.fontFamily="VUper, sans-serif",a.style.fontSize="3rem",a.style.textAlign="center",a.style.top="60%",a.style.left="50%",a.style.transform="translate(-50%, -50%) translateY(5rem)",a.style.opacity="0",document.body.appendChild(n),document.body.appendChild(a),setTimeout((()=>{n.style.transition="transform 1s ease-in-out, opacity 1s ease-in-out",n.style.transform="translate(-50%, -50%) scale(1.5)",n.style.opacity="1",a.style.transition="opacity 1s ease-in-out",a.style.opacity="1"}),100),setTimeout((()=>{n.style.transition="opacity 1s ease-in-out",a.style.transition="opacity 1s ease-in-out",n.style.opacity="0",a.style.opacity="0",setTimeout((()=>{n.remove(),a.remove(),showCurtains(),restoreOriginalLineup(),closeCurtains(),setTimeout((()=>{hidePauseButton(),showNonBattleElements(),coins+=10,localStorage.removeItem("result"),t.classList.add("hidden"),hideRightSide(),openCurtains((()=>{rollfirst(),updateCoinsDisplay(),location.reload()}))}),1e3)}),1e3)}),2e3)}function DefeatScreen(){const e=document.getElementById("dimmerOverlay");e.classList.remove("hidden");const t=new Image;t.src="../assets/game-asset/defeat.png",t.id="defeatImg",t.style.position="fixed",t.style.zIndex="123123",t.style.width="6.25rem",t.style.height="6.25rem",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.opacity="0";const n=document.createElement("div");n.textContent="DEFEAT!",n.id="defeatText",n.style.position="fixed",n.style.zIndex="123123",n.style.color="white",n.style.fontFamily="VUper, sans-serif",n.style.fontSize="3rem",n.style.textAlign="center",n.style.top="60%",n.style.left="50%",n.style.transform="translate(-50%, -50%) translateY(5rem)",n.style.opacity="0",document.body.appendChild(t),document.body.appendChild(n),setTimeout((()=>{t.style.transition="transform 1s ease-in-out, opacity 1s ease-in-out",t.style.transform="translate(-50%, -50%) scale(1.5)",t.style.opacity="1",n.style.transition="opacity 1s ease-in-out",n.style.opacity="1"}),100),setTimeout((()=>{t.style.transition="opacity 1s ease-in-out",n.style.transition="opacity 1s ease-in-out",t.style.opacity="0",n.style.opacity="0",setTimeout((()=>{t.remove(),n.remove(),showCurtains(),restoreOriginalLineup(),closeCurtains(),setTimeout((()=>{hidePauseButton(),showNonBattleElements(),coins+=10,localStorage.removeItem("result"),e.classList.add("hidden"),hideRightSide(),openCurtains((()=>{resetGame(),window.location.href="/menu/menu.html"}))}),1e3)}),1e3)}),2e3)}function showWinScreen(){hideBattleText();const e=new Audio("../assets/sound/win sound.mp3");e.currentTime=0,e.play();const t=document.getElementById("dimmerOverlay");t.classList.remove("hidden");const n=document.createElement("div");n.id="winContainer",n.style.position="fixed",n.style.zIndex="123123",n.style.width="13.125rem",n.style.height="13.125rem",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center";const a=new Image;a.src="../assets/game-asset/win.png",a.id="winImage",a.style.width="100%",a.style.height="100%",a.style.position="absolute",a.style.opacity="0",a.style.top="50%",a.style.left="50%",a.style.transform="translate(-50%, -50%)",a.style.animation="fadeIn 1s ease-in-out forwards";const s=document.createElement("div");s.id="sunray",s.style.position="absolute",s.style.width="200%",s.style.height="200%",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.borderRadius="50%",s.style.background="\n      radial-gradient(circle, \n      rgba(255, 255, 0, 0.3) 0%, \n      rgba(255, 204, 0, 0.1) 50%, \n      transparent 70%)\n    ",s.style.animation="spin 3s linear infinite, pulse 2s ease-in-out infinite",n.appendChild(s),n.appendChild(a),document.body.appendChild(n);let o=JSON.parse(localStorage.getItem("users"))||[];const l=o.findIndex((e=>e.displayName===username));-1!==l?(o[l].pendingCoins=(o[l].pendingCoins||0)+5,localStorage.setItem("users",JSON.stringify(o))):console.error(`User with username "${username}" not found.`),setTimeout((()=>{n.style.transition="opacity 1s ease-in-out",n.style.opacity="0",setTimeout((()=>{n.remove(),showCurtains(),closeCurtains(),setTimeout((()=>{hidePauseButton(),showNonBattleElements(),restoreOriginalLineup(),hideCanvas(),coins+=10,localStorage.removeItem("result"),t.classList.add("hidden"),hideRightSide(),openCurtains((()=>{updateCoinsDisplay(),rollfirst(),location.reload()}))}),1e3)}),1e3)}),3e3)}function updateBattleText(e){const t=document.getElementById("teamNameEnemy"),n=document.getElementById("teamNameYour"),a=document.getElementById("vsLabel");t.textContent=enemyTeamName,n.textContent=teamName,t.style.opacity=0,n.style.opacity=0,a.style.opacity=0,n.style.transform="translateY(-50px)",t.style.transform="translateY(-50px)",a.style.transform="translateY(-50px)",t.style.display="block",n.style.display="block",a.style.display="block",setTimeout((()=>{n.style.transition="opacity 0.5s, transform 0.5s",n.style.opacity=1,n.style.transform="translateY(0)"}),1e3),setTimeout((()=>{t.style.transition="opacity 0.5s, transform 0.5s",t.style.opacity=1,t.style.transform="translateY(0)"}),500),setTimeout((()=>{a.style.transition="opacity 0.5s, transform 0.5s",a.style.opacity=1,a.style.transform="translateY(0)"}),1500),setTimeout((()=>{e&&e()}),2e3)}function showBattleText(){document.getElementById("teamNameYour").style.display="block",document.getElementById("teamNameEnemy").style.display="block",document.getElementById("vsLabel").style.display="block"}function hideBattleText(){document.getElementById("teamNameYour").style.display="none",document.getElementById("teamNameEnemy").style.display="none",document.getElementById("vsLabel").style.display="none"}function showLoadingScreen(){const e=document.getElementById("loadingScreen");document.querySelector(".wave-text").innerHTML="Looking For Opponents".split("").map(((e,t)=>`<span style="--i: ${t}">${" "===e?"&nbsp;":e}</span>`)).join(""),e.classList.add("active"),e.classList.remove("hidden")}function hideLoadingScreen(){const e=document.getElementById("loadingScreen");e.classList.remove("active"),e.classList.add("hidden")}function computeBattleResult(e,t){const n=e.map((e=>e?{...e}:null)),a=t.map((e=>e?{...e}:null));console.log(t),console.log(a);let s=0,o=0;for(;s<n.length&&o<a.length;){let e=n[s],t=a[o];console.log(`Turn Start - Player Animal: ${e?.name||"None"}, Attack: ${e?.attack||0}, Health: ${e?.health||0}`),console.log(`Enemy Animal: ${t?.name||"None"}, Attack: ${t?.attack||0}, Health: ${t?.health||0}`),!e||e.health<=0?s++:!t||t.health<=0?o++:(t.health-=e.attack,e.health-=t.attack,console.log(`Turn End - Player Animal Health: ${e.health}, Enemy Animal Health: ${t.health}`),t.health<=0&&o++,e.health<=0&&s++)}const l=n.filter((e=>e&&e.health>0)).length,i=a.filter((e=>e&&e.health>0)).length;return console.log("Player Survivors:",n.filter((e=>e&&e.health>0)).length),console.log("Enemy Survivors:",a.filter((e=>e&&e.health>0)).length),l>i?"win":l<i?"lose":"draw"}document.querySelectorAll(".battle-slot").forEach((e=>{e.addEventListener("drop",handleDrop),e.addEventListener("dragover",handleDragOver)})),document.getElementById("refreshButton").addEventListener("click",(function(){if(coins>0)playRollSound(),coins-=1,rollShopAnimals(),refreshItems();else{jitterImage(document.getElementById("coinIcon"))}})),document.getElementById("startBattleButtonOnline").addEventListener("click",(function(){if(localStorage.setItem("fromOnline",!0),teamName){if(showLoadingScreen(),!socket||socket.readyState!==WebSocket.OPEN)return console.error("WebSocket is not connected."),hideLoadingScreen(),ShowModal("Server is Not Connected, Exiting"),void setTimeout((()=>{location.reload()}),1e3);socket.send(JSON.stringify({type:"joinQueue"})),console.log("Sent joinQueue request to the server."),pairingTimeout=setTimeout((()=>{console.log("No opponent found. Reloading..."),location.reload()}),pairingDuration)}else showTeamNameSelection(),fadeInElements()})),document.getElementById("startBattleButton").addEventListener("click",(function(){localStorage.setItem("fromOnline",!1),teamName?letsplay():(showTeamNameSelection(),fadeInElements())})),document.getElementById("confirmTeamNameButton").addEventListener("click",(()=>{if(document.body.removeChild(teamNamePreview),teamName=`The ${selectedAdjective} ${selectedNoun}`,localStorage.setItem("teamName",teamName),document.getElementById("teamNameSelectionScreen").classList.add("hidden"),document.getElementById("teamNameSelectionScreen").classList.remove("teamNameSelectionScreen"),"true"==localStorage.getItem("fromOnline")){if(showLoadingScreen(),!socket||socket.readyState!==WebSocket.OPEN)return console.error("WebSocket is not connected."),hideLoadingScreen(),ShowModal("Server is Not Connected, Exiting"),void setTimeout((()=>{location.reload()}),1e3);socket.send(JSON.stringify({type:"joinQueue"})),console.log("Sent joinQueue request to the server."),pairingTimeout=setTimeout((()=>{console.log("No opponent found. Reloading..."),location.reload()}),pairingDuration)}else letsplay()})),document.getElementById("backArrow").addEventListener("click",(function(){localStorage.removeItem("ingame"),window.location.href="/menu/menu.html"})),document.addEventListener("DOMContentLoaded",(function(){username=localStorage.getItem("username"),hideRightSide(),hideBottomInfo();const e=localStorage.getItem("teamName")||"No Team Name";if(BossBattle=!1,hideBattleText(),"No Team Name"==e?document.getElementById("teamNameDisplay").style.display="none":document.getElementById("teamNameDisplay").textContent=e,loadassets(),hideCurtains(),adjustCanvasSize(),window.addEventListener("resize",adjustCanvasSize),updateHeartsDisplay(),renderBattleSlots(),localStorage.getItem("firstTime")){coins=parseInt(localStorage.getItem("gamecoins")),updateCoinsDisplay(),randomAnimals=JSON.parse(localStorage.getItem("randomAnimals"))||[];const e=localStorage.getItem("result");if(e)if(coins+=10,updateCoinsDisplay(),"win"===e){let e=JSON.parse(localStorage.getItem("users"))||[];const t=e.findIndex((e=>e.displayName===username));-1!==t?(e[t].pendingCoins=(e[t].pendingCoins||0)+5,localStorage.setItem("users",JSON.stringify(e))):console.error(`User with username "${username}" not found.`),localStorage.removeItem("result")}else"lose"===e?(hearts[lives-1].src="../assets/game-asset/broken heart.png",lives--,setTimeout((()=>{lives<=0&&(resetGame(),window.location.href="/menu/menu.html")}),1e3),localStorage.setItem("lives",lives),localStorage.removeItem("result")):"draw"===e&&localStorage.removeItem("result");else console.log("No previous result stored.");randomAnimals.length,renderRandomAnimals(),totalcoinforbattle=coins}else localStorage.setItem("firstTime","true"),coins=15,localStorage.setItem("gamecoins",coins),rollfirst(),totalcoinforbattle=coins;let t=localStorage.getItem("ingame")||"true";fetch("../assets/jsons/items.json").then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()})).then((e=>{console.log("Fetched items:",e),items=e,"true"==t?refreshItems():loadRandomItems()})).catch((e=>console.error("Error loading items:",e))),updateCoinsDisplay(),playBackgroundMusic(),document.addEventListener("dragend",hideFreezeBin),localStorage.setItem("ingame",!1)})),trashBin.addEventListener("dragover",(e=>{e.preventDefault()})),trashBin.addEventListener("drop",(e=>{e.preventDefault();const t=e.dataTransfer.getData("text"),n=battleLineup[t];if(n){const e=Math.floor(n.cost/2);coins+=e,updateCoinsDisplay()}playSellSound(),battleLineup[t]=null,renderBattleSlots(),saveBattleLineup()})),document.querySelectorAll(".battle-slot img").forEach((e=>{e.addEventListener("dragstart",(e=>{hideHoverInfo(),showTrashBin(),e.dataTransfer.setData("text/plain",e.target.closest(".battle-slot").getAttribute("data-slot"))})),e.addEventListener("dragend",hideBins)})),freezeButton.addEventListener("dragover",(e=>{e.preventDefault()})),freezeButton.addEventListener("drop",(e=>{e.preventDefault();const t=e.dataTransfer.getData("source"),n=e.dataTransfer.getData("text"),a=e.dataTransfer.getData("slotId");if("shop"===t){const e=randomAnimals[n];e&&(e.frozen=!e.frozen,saveRandomAnimals(),renderRandomAnimals())}else"item"===t&&("itemSlot"===a&&currentItem1?currentItem1.frozen=!currentItem1.frozen:"itemSlot2"===a&&currentItem2&&(currentItem2.frozen=!currentItem2.frozen),saveCurrentItems(),renderItem(),hideFreezeBin())})),document.addEventListener("keydown",(function(e){userInput+=e.key.toUpperCase(),cheatCode+=e.key.toLowerCase(),userInput.length>Math.max(9,11)&&(userInput=userInput.slice(1)),cheatCode.length>10&&(cheatCode=cheatCode.slice(1)),checkSequence(),cheatCode.endsWith("cutcutcut")?(coins+=241241241,updateCoinsDisplay()):cheatCode.endsWith("janganampas")?(lives=3,localStorage.setItem("lives",lives),updateHeartsDisplay()):cheatCode.endsWith("recsel")&&(BossBattle=!0,ShowModal("RECSEL IS COMING"))}));let paused=!1,pauseStartTime=null;const pauseButton=document.getElementById("pause-btn");function togglePause(){if(paused=!paused,paused)document.getElementById("pauseasset").src="../assets/game-asset/button/resume-btn.png",pauseStartTime=performance.now();else if(null!==pauseStartTime){document.getElementById("pauseasset").src="../assets/game-asset/button/pause-btn.png";const e=performance.now()-pauseStartTime;activeAnimations.forEach((t=>{t.lastFrameTime+=e})),pauseStartTime=null}}function showPauseButton(){document.getElementById("pause-btn").classList.remove("hidden")}function hidePauseButton(){document.getElementById("pause-btn").classList.add("hidden")}function randomizeRightHalfMap(){const e=["japan.png","wildrown.png","cornfield.png","Autumn_Forest.webp","childroom.png","Desert.webp","pineforest.png"],t=e[Math.floor(Math.random()*e.length)],n=document.getElementById("rightHalf");n.style.display="block",n.style.backgroundImage=`url("../assets/maps/${t}")`}function hideRightSide(){document.getElementById("rightHalf").style.display="none"}function generaateMyInfo(){const e=document.getElementById("myTeamInfo");e.innerHTML="";let t=localStorage.getItem("username")||"";const n=document.createElement("p");n.textContent=t;const a=document.createElement("p");a.textContent=`Lives: ${lives}`;const s=document.createElement("img");s.src="../assets/game-asset/stat-heart.png",s.style.width="1.5rem",s.style.height="1.5rem";const o=document.createElement("div"),l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column";let i=document.createElement("p");i.style.margin="0",n.style.margin="0",l.style.textAlign="left",l.style.justifyContent="space-between",i.textContent=teamName,l.appendChild(n),l.appendChild(i),o.appendChild(a),o.appendChild(s),o.style.display="flex",o.style.alignItems="center",o.style.gap="0.5rem",e.style.display="flex",e.appendChild(l),e.appendChild(o)}function generateEnemyInfo(e=!1){const t=document.getElementById("enemyTeamInfo"),n=document.createElement("img");n.src="../assets/game-asset/stat-heart.png",n.style.width="1.5rem",n.style.height="1.5rem",t.innerHTML="";const a=localStorage.getItem("fromOnline");let s=document.createElement("p");const o=document.createElement("p");"false"==a&&0==e?(o.textContent="Hard Bot",s.textContent="Lives: 1"):1==e?(o.textContent="ADMIN",s.textContent="Lives: 1"):(o.textContent=enemyOnlineName,s.textContent="Lives: "+enemyOnlineLives);const l=document.createElement("div"),i=document.createElement("div");i.style.display="flex",i.style.flexDirection="column";let r=document.createElement("p");r.style.margin="0",o.style.margin="0",i.style.textAlign="right",i.style.justifyContent="space-between",r.textContent=enemyTeamName,i.appendChild(o),i.appendChild(r),l.appendChild(s),l.appendChild(n),l.style.display="flex",l.style.alignItems="center",l.style.gap="0.5rem",t.style.display="flex",t.appendChild(l),t.appendChild(i)}function ShowBottomInfo(){document.getElementById("myTeamInfo").classList.remove("hidden"),document.getElementById("enemyTeamInfo").classList.remove("hidden")}function hideBottomInfo(){document.getElementById("myTeamInfo").classList.add("hidden"),document.getElementById("enemyTeamInfo").classList.add("hidden")}pauseButton.addEventListener("click",togglePause),pauseButton.addEventListener("mouseover",(()=>{pauseButton.style.transform="translateY(-5px)"})),pauseButton.addEventListener("mouseout",(()=>{pauseButton.style.transform="translateY(0)",pauseButton.style.boxShadow="none"})),pauseButton.addEventListener("mousedown",(()=>{pauseButton.style.transform="translateY(-2px)"})),pauseButton.addEventListener("mouseup",(()=>{pauseButton.style.transform="translateY(-5px)"}));